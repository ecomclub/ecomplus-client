"use strict";var isNodeJs=false;if(typeof module!=="undefined"&&module.exports){isNodeJs=true}var EcomIo=function(){let storeId,https,loggerif(isNodeJs){https=require("https")}let logHeader=function(a){return"E-Com Plus SDK "+a+":"}let errorHandling=function(c,a,b){if(typeof c==="function"){let err=new Error(a)if(b===undefined){c(err,null)}else{c(err,b)}}logger.log(logHeader("WARNING")+"\n"+a)}let runMethod=function(d,c,b,a){if(typeof d!=="function"){let msg="You need to specify a callback function to receive the request response"errorHandling(null,msg);return}let pathif(!b){b="api.e-com.plus";path="/v1"}else{if(b!=="api.e-com.plus"){path="/api/v1"}else{path="/v1"}}path+=c;let tries=0sendRequest(tries,b,path,a,d);let msg=logHeader("INFO")+"\nAPI endpoint\n"+clogger.log(msg)}let sendRequest=function(d,b,c,a,e){let methodif(!a){method="GET"}else{method="POST"}if(isNodeJs===true){let options={hostname:b,path:c,method:method,headers:{"Content-Type":"application/json","X-Store-ID":storeId}}let req=https.request(options,function(f){if(f.statusCode===503&&d<3){setTimeout(function(){sendRequest(d,b,c,a,e)},500);f.resume();return}let rawData=""f.setEncoding("utf8");f.on("data",function(g){rawData+=g});f.on("end",function(){response(f.statusCode,rawData,e)})})req.on("error",function(f){logger.error(f);e(f,null)});if(a){req.write(JSON.stringify(a))}req.end()}else{let ajax=new XMLHttpRequest()let url="https://"+b+cajax.open(method,url,true);if(a){ajax.send(JSON.stringify(a))}else{ajax.send()}ajax.onreadystatechange=function(){if(this.readyState===4){if(this.status===503&&d<3){setTimeout(function(){sendRequest(d,b,c,a,e)},500);return}response(this.status,this.responseText,e)}}}d++}let response=function(a,c,d){let bodytry{body=JSON.parse(c)}catch(b){logger.error(b);d(b,null);return}if(a===200){d(null,body)}else{let msgif(body.hasOwnProperty("message")){msg=body.message}else{msg="Unknown error, see response objet to more info"}errorHandling(d,msg,body)}}let idValidate=function(b,a){let msgif(typeof a==="string"){if(a.match(/^[a-f0-9]{24}$/)){return true}else{msg="ID must be a valid 24 hexadecimal digits string, lowercase only"}}else{msg="ID is required and must be a string"}errorHandling(b,msg);return false}let getById=function(c,a,b){if(idValidate(c,b)){let host="cache.e-com.plus"runMethod(c,"/"+a+"/"+b+".json",host)}}let getByField=function(f,c,e,a,d,b){if(typeof c==="string"){runMethod(function(h,g){if(!h){let results=g.resultif(Array.isArray(results)&&typeof results[0]==="object"&&results[0]!==null){b(f,results[0]._id)}else{let msg="Any "+a+" found with this "+eerrorHandling(f,msg,g)}}else{f(h,g)}},d)}else{let msg="The"+e+" is required and must be a string"errorHandling(f,msg)}}let queryString=function(e,b,c,a,d){let params={}let query=""if(typeof d!=="string"){if(typeof e==="number"&&e>0){params.offset=e}if(typeof b==="number"&&b>0){params.limit=b}if(typeof c==="number"){switch(c){case 1:params.sort="name";break;case 2:params.sort="-name";break}}if(Array.isArray(a)){let fieldsString=""for(let i=0;i<a.length;i++){if(typeof a[i]==="string"){if(fieldsString!==""){fieldsString+="%2C"}fieldsString+=a[i]}}if(fieldsString!==""){params.fields=fieldsString}}for(let param in params){if(params.hasOwnProperty(param)){if(query!==""){query+="&"}query+=param+"="+params[param]}}}else{query=d}if(query!==""){query="?"+query}return query}return{init:function(b,a){storeId=b;if(typeof a==="object"&&a.hasOwnProperty("log")&&a.hasOwnProperty("error")){logger=a}else{logger=console}},storeId:function(){return storeId},getProduct:function(b,a){getById(b,"products",a)},getProductBySku:function(b,a){let endpoint="/products.json?sku="+agetByField(b,a,"SKU","product",endpoint,EcomIo.getProduct)},getOrder:function(b,a){getById(b,"orders",a)},getCart:function(b,a){getById(b,"carts",a)},getCustomer:function(b,a){getById(b,"customers",a)},getApplication:function(b,a){getById(b,"applications",a)},getBrand:function(b,a){getById(b,"brands",a)},findBrandBySlug:function(b,a){let endpoint="/brands.json?limit=1&slug="+agetByField(b,a,"slug","brand",endpoint,EcomIo.getBrand)},listBrands:function(f,e,b,c,a,d){let endpoint="/brands.json"+queryString(e,b,c,a,d)runMethod(f,endpoint)},getCategory:function(b,a){getById(b,"categories",a)},findCategoryBySlug:function(b,a){let endpoint="/categories.json?limit=1&slug="+agetByField(b,a,"slug","category",endpoint,EcomIo.getCategory)},listCategories:function(f,e,b,c,a,d){let endpoint="/categories.json"+queryString(e,b,c,a,d)runMethod(f,endpoint)},getCollection:function(b,a){getById(b,"collections",a)},findCollectionBySlug:function(b,a){let endpoint="/collections.json?limit=1&slug="+agetByField(b,a,"slug","collection",endpoint,EcomIo.getCollection)},listCollections:function(f,e,b,c,a,d){let endpoint="/collections.json"+queryString(e,b,c,a,d)runMethod(f,endpoint)},searchProduts:function(h,b,g,k,d,a,j,e,c,f){let host="apx-search.e-com.plus"let endpoint="/items.json"let bodyif(typeof f==="object"&&f!==null){body=f}else{if(typeof b!=="string"){let msg="Search term is required and must be a string"errorHandling(h,msg);return}if(typeof d==="number"){switch(d){case 1:d={sales:"desc"};break;case 2:d={price:"asc"};break;case 3:d={price:"desc"};break;default:d={views:"desc"}}}else{d={views:"desc"}}body={query:{multi_match:{query:b,fields:["name","keywords"]},sort:[{available:true},"_score",{ad_relevance:"desc"},d],bool:{filter:[{term:{visible:true}}]}},aggs:{brands:{terms:{field:"brands.name"}},categories:{terms:{field:"categories.name"}},specs:{nested:{path:"specs"},aggs:{grid:{terms:{field:"specs.grid",size:12},aggs:{text:{terms:{field:"specs.text"}}}}}},min_price:{min:{field:"price"}},max_price:{max:{field:"price"}},avg_price:{avg:{field:"price"}}}};if(typeof g==="number"&&g>0){body.from=g}if(typeof k==="number"&&k>0){body.size=k}else{body.size=24}if(typeof a==="object"&&a!==null&&Object.keys(a).length>0){let nestedQuery={nested:{path:"specs",query:{bool:{filter:[]}}}}for(let key in a){if(Array.isArray(a[key])&&a[key].length>0){nestedQuery.nested.query.bool.filter.push({term:{"specs.grid":key}},{terms:{"specs.text":a[key]}});body.query.bool.filter.push(nestedQuery)}}}if(Array.isArray(j)&&j.length>0){body.query.bool.filter.push({terms:{"brands.name":j}})}if(Array.isArray(e)&&e.length>0){body.query.bool.filter.push({terms:{"categories.name":e}})}if(typeof c==="object"&&c!==null&&Object.keys(c).length>0){let rangeQuery={range:{price:{}}}if(typeof c.min==="number"&&!isNaN(c.min)){rangeQuery.range.price.gte=c.min}if(typeof c.max==="number"&&!isNaN(c.max)){rangeQuery.range.price.lte=c.max}body.query.bool.filter.push(rangeQuery)}}let msg=logHeader("INFO")+"\nQuery DSL\n"+JSON.stringify(body)logger.log(msg);runMethod(h,endpoint,host,body)},listRecommendedProducts:function(b,a){if(idValidate(a)){let host="apx-graphs.e-com.plus"runMethod(b,"/products/"+a+"/recommended.json",host)}},listRelatedProducts:function(b,a){if(idValidate(a)){let host="apx-graphs.e-com.plus"runMethod(b,"/products/"+a+"/related.json",host)}},http:runMethod}};EcomIo=EcomIo();if(isNodeJs){module.exports=EcomIo};